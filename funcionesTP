create or replace function a_de_compra(nrotarjetax char , codseguridadx char , nrocomerciox int , montox decimal) returns boolean as $$

declare

montoCompraSum record;
tarjetaRecord;
nrechazo record;
ncompra record;
montoTotal int;

begin

select count (nrocompra) into ncompra from compra;
select count(nrorechazo) into nrechazo from rechazo;
select sum(monto) into montoCompraSum from compra where nrotarjeta=nrotarjetax and pagado = false;
montoTotal := montoCompraSum + montox;


select * from tarjeta into tarjetaRecord where nrotarjeta = nrotarjetax

if not found then  /*el select no trajo registros*/
	insert into rechazo values (nrechazo.nrorechazo,nrotarjetax,nrocomerciox,current_timestamp,montox,'tarjeta no valida o no vigente');
	return false;
elsif tarjetaRecord.codseguridad = codseguridadx then
	insert into rechazo values (nrechazo.nrorechazo,nrotarjetax,nrocomerciox,current_timestamp,montox,'codigo de seguridad invalido');
	return false;
elsif tarjetaRecord.validahasta > current_date then
	insert into rechazo values (nrechazo.nrorechazo,nrotarjetax,nrocomerciox,current_timestamp,montox,'plazo de vigencia expirado');
	return false;
elsif tarjetaRecord.estado = 'suspendido' then
	insert into rechazo values (nrechazo.nrorechazo,nrotarjetax,nrocomerciox,current_timestamp,montox,'la tarjeta se encuentra suspendida');
	return false;
elsif tarjetaRecord.limitecompra < montoCompraSum then
	insert into rechazo values (nrechazo.nrorechazo,nrotarjetax,nrocomerciox,current_timestamp,montox,'supera limite de tarjeta');
	return false;
else 
	insert into compra values (ncompra.nrocompra,nrotarjetax,nrocomerciox,current_timestamp,montox,false);
	return true;
end if;

end;
$$language plpgsql;





create or replace function generar_resumen(nroclientex int , mesx int , anox int) returns void as $$

declare 

ncliente record;
ntarjeta record;
nresumen record;
ncierre record;
numerotarjeta char


gasto record;


begin 

select count(nroresumen) into nresumen from cabecera;
select * into ncliente from cliente where nrocliente = nroclientex ;
select * into ntarjeta from tarjeta where nrocliente = nroclientex and estado = vigente; 

numerotarjeta := ntarjeta.nrotarjeta

substr(numerotarjeta,-1,1);



select * into ncierre from cierre where ano = anox and mes = mesx and terminacion = digito; 
select suma(monto) into gasto from consumo where nrotarjeta = c.nrotarjeta and codseguridad = c.codseguridad;


insert into cabecera values (nresumen.nroresumen,ncliente.nombre,ncliente.apellido,ncliente.domicilio,ntarjeta.nrotarjeta,ncierre.fechainicio,ncierre.fechacierre,ncierre.fechavto,gasto.monto);
insert into detalle values ();  /* consultar */
 
end;

$$ language psplsql;









create or replace function xxxxxxx returns trigger as $$

declare
	nalerta int;
	ntarjeta varchar(16);
	fecha timestamp;
	nrechazo int;
	codalerta int;
	descripcion text;
begin 
	select max(nroalerta) into nalerta from alerta;

	if not found then	
		nalerta := 0; 
	else 
		nalerta:= nalerta+1;	
	end if;

	select max(nrorechazo) into nrechazo from rechazo;

	if not found then	
		nrechazo := 0; 

	select nrotarjeta into ntarjeta where nrorechazo = nrechazo;

	codalerta := 0; //codigo por rechazo

	fecha:= time.Now(); //duda

	descripcion := 'Alerta por rechazo';

	insert into alerta values (nalerta, ntarjeta, fecha, nrechazo, codalerta, descripcion);
	
end;

$$ language plpgsql;

create trigger alerta_a_clientes()

after update on rechazo

for each row

execute procedure 
