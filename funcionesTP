create or replace function a_de_compra(nrotarj char , codsegur char , nrocomerc int , mont decimal) returns boolean as $$

declare

i record;

ncompra record
nrechaz record
pagos record

nrorechaz int; 
nrocompr int;

mtotal int;

begin


select max(nrocompra) into ncompra from compra where nrotarjeta = nrotarj;
if not found then
 nrocompr := 0
else 
 nrocompr:= ncompra.nrocompra;
end if;

select max(nrorechazo) into nrechaz from rechazo where nrotarjeta = nrotarj;
if not found then
 nrorechaz := 0
else
 nrorechaz := nrechaz.nrorechazo;
end if;

select sum(monto) into pagos from compra where nrotarjeta=nrotarj

mtotal := pagos.monto + mont;


for i in select * from tarjeta loop
	if i.nrotarjeta = nrotarj then
				
		if i.codseguridad = codsegur then
			
			if b.estado = 'anulado' then
				insert into rechazo values (nrorechaz,nrotarj,nrocomerc,current timestamp,mont,'plazo de vigencia expirado');
				return false;
			end if;
			
			if b.estado = 'vencido' then
				insert into rechazo values (nrorechaz,nrotarj,nrocomerc,current timestamp,mont,'la tarjeta se encuentra suspendida');
				return false;
			end if;
			
			if mtotal > b.limitecompra then
				insert into rechazo values (nrorechaz,nrotarj,nrocomerc,current timestamp,mont,'supera limite de tarjeta');
				return false;
			else 
				insert into compra values (nrcompr+1,nrotarj,nrocomerc,current_timestamp,mont,true);
				return true;
			end if;
				
			
		else
			insert into rechazo values (nrorechaz,nrotarj,nrocomerc,current timestamp,mont,'codigo de seguridad invalido');
			return false;
		end if;
	else
		insert into rechazo values (nrorechaz,nrotarj,nrocomerc,current timestamp,mont,'tarjeta no valida o no vigente');
		return false;
	
	end if;	
end loop;


$$ language pgplsql;






create or replace function generar_resumen(nroclien int , peridoi date,peridiof date) returns void as $$

declare 

p record;
c record;
nresumen record;
nroresum int;


begin 

select max(nroresumen) into nresumen from cabecera;
if not found then
	nroresum := 0;
else 
	nroresum := nresumen.nroresumen;
end if;

select * into person from cliente where nrocliente = nroclien ;

select * into card from tarjeta where nrocliente = nroclien and estado = vigente; 

insert into cabecera values (nroresum+1,p.nombre,p.apellido,p.domicilio,c.nrotarjeta,periodoi,peridof,c.validahasta,..);

 
end;

$$ language psplsql;



create or replace function xxxxxxx returns trigger as $$

declare

begin 

end;

$$ language plpgsql;

create trigger alerta_a_clientes()

after update on rechazo

for each row

execute procedure 
